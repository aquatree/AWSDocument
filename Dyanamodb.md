# Dynamodb

## キーについて

* プライマリキー
  * =パーティションキー、あるいはパーティションキー+ソートキー
* パーティションキー
  * プライマリキーがこれのみの場合、dynamodbはパーティションキーの値を内部ハッシュ関数への入力とする。
  * ハッシュ関数の出力によって、その項目がどのパーティションに保存されるかが決まる
* ソートキー
  * パーティションキーが同じ値の場合、同じパーティションに割り当てられる。
  * ソートキーは一意である必要がある

パフォーマンス向上には、カーディナリティが高いパーティションキーを使うことが有効。  

* 一部のパーティションにアクセスが集中すると、プロビジョニングされたI/O容量が非効率に使用される可能性がある
* 既存のパーティションが容量一杯になると追加されストレージ領域がたくさん必要。

上記の理由より、カーディナリティが高いパーティションキーを使用してデータを分散させ、かつそれぞれのパーティションになるべく均等になるようなアクセスができれば、プロビジョニングされたスループットを効率よく使用できる。

## セカンダリインデックス

オリジナルのプライマリキーでは不十分な場合、別のパーティションキー・ソートキーを設定できる。  
インデックスにおいては一意制約はないのでキーが重複してもOK

* グローバルセカンダリインデックス(GSI)
  * あるテーブルをベースに、パーティションキー、ソートキー（任意）を新しく設定したテーブルを作成する仕組み
  * サイズ制限なしだが、読み込みの整合性は「結果整合性」のみ
  * テーブル作成後に追加可能
* ローカルセカンダリインデックス(LSI)
  * あるテーブルをベースに、パーティションキーはそのままでソートキーだけを新しく設定したテーブルを作成する仕組み
  * サイズ制限は10G以下で、整合性は「強い整合性」も選択可
  * テーブル作成後は追加不可能

## RCUとWCU

### RCU

* RCU: 読み込みキャパシティーユニット
* 1RCUは、最大サイズ4KBの項目に対して、以下のことが出来る
  * 1秒あたり2回の結果整合性のある読み込み
  * 1秒あたり1回の強い結果整合性のある読み込み
* 4KB以上の場合、より多くのユニットを消費する
* トランザクションの読み込みの場合、1RCUで1秒あたり1回読み込みができる

### WCU

* WCU: 書き込みキャパシティーユニット
* 1WCUは最大サイズ1KBに対して1秒あたり1回の書き込みができる
* トランザクションの書き込みの場合、1KBに対して1秒あたり1回書き込むためには2WCUを使用する

## Dynamodb ストリーム

* 有効にすると、更新などDynamodbのイベントをトリガーとして、Lambda関数などを実行できる
  * INSERT: アイテム新規作成
  * MODIFY: 既存アイテムに属性を新規追加、または既存アイテムの既存キーの値を変更
  * REMOVE: 既存アイテムを削除
* アクセスできるデータは24h以内に変更されたもの
* 以下の4種類の表示タイプ（StreamViewType）がある
  * KEYS_ONLY: 変更されたキー属性のみ
  * NEW_IMAGE: 変更後に表示される項目全体
  * OLD_IMAGE: 変更前に表示されていた項目全体
  * NEW_AND_OLD_IMAGES: 新しいイメージと古いイメージの両方

## プロジェクション式

* dynamodb からデータを読み取るとき、デフォルトでは全ての属性を取得する
* プロジェクション式を使用することで特定の属性のみを取得できる
* 複数属性を指定する場合、カンマで区切って指定する

```bash
aws dynamodb get-item \
--table-name ProductCatalog \
--key '{"Id":{"N":"123"}}' \
--projection-expression "Safety.Warning"
```

## TTL

* テーブルに設定するデータの有効期限。これを過ぎたレコードを自動的に削除し、ストレージ使用料を効率化できる

## アトミックカウンター

* 書き込みリクエストを妨害することなく無条件で象分される数値属性。
* UpdateItemオペレーションを使用する。
* ↑に失敗した場合は再試行するので二重計上の可能性がある。厳密なカウンターにはならない。
